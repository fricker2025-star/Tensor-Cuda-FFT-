name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test PyTorch Fallback (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch numpy pytest pytest-cov
    
    - name: Verify package structure
      run: |
        ls -la fft_tensor/
        ls -la fft_lm/ || true
        ls -la scripts/ || true
        test -f fft_tensor/__init__.py && echo "✓ Package found"
        test -f fft_tensor/tensor.py && echo "✓ tensor.py found"
        test -f fft_tensor/ops.py && echo "✓ ops.py found"
        test -f fft_lm/train_fixed_full.py && echo "✓ fft_lm/train_fixed_full.py found" || true
    
    - name: Check Python syntax
      run: |
        python test_syntax.py
    
    - name: Test imports
      run: |
        python -c "from fft_tensor import sst, MemoryManager; print('✓ Imports successful')"
        python -c "import fft_tensor; print(f'Version: {fft_tensor.__version__}')"
    
    - name: Run unit tests
      run: |
        pytest tests/unit/test_tensor.py -v --cov=fft_tensor --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      continue-on-error: true

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install linting tools
      run: |
        pip install black flake8
    
    - name: Check code formatting with black
      run: |
        black --check fft_tensor/ fft_lm/ scripts/ tests/ examples/ || echo "⚠ Code formatting issues found (non-blocking)"
      continue-on-error: true
    
    - name: Check code style with flake8
      run: |
        flake8 fft_tensor/ fft_lm/ scripts/ tests/ examples/ --max-line-length=100 --extend-ignore=E203,W503,E501 || echo "⚠ Style issues found (non-blocking)"
      continue-on-error: true

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check required files
      run: |
        test -f README.md && echo "✓ README.md"
        test -f INSTALL.md && echo "✓ INSTALL.md"
        test -f CONTRIBUTING.md && echo "✓ CONTRIBUTING.md"
        test -f LICENSE && echo "✓ LICENSE"
        test -f requirements.txt && echo "✓ requirements.txt"
        test -f setup.py && echo "✓ setup.py"
    
    - name: Check documentation sections
      run: |
        grep -q "Installation" README.md && echo "✓ Installation section"
        grep -q "Usage" README.md && echo "✓ Usage section"
        grep -q "Example" README.md && echo "✓ Examples section"
    
    - name: Check test files
      run: |
        test -f tests/unit/test_tensor.py && echo "✓ Unit tests"
        test -f tests/integration/test_performance.py && echo "✓ Integration tests"
    
    - name: Check example files
      run: |
        test -f examples/basic_usage.py && echo "✓ basic_usage.py"
        test -f examples/neural_network.py && echo "✓ neural_network.py"

  examples:
    name: Example Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install torch numpy
    
    - name: Compile example files
      run: |
        python -m py_compile examples/basic_usage.py
        python -m py_compile examples/neural_network.py
        echo "✓ Examples compile successfully"
    
    - name: Test basic functionality
      run: |
        python -c "
        import torch
        from fft_tensor import sst, MemoryManager
        
        # CPU test (no GPU needed)
        data = torch.randn(64, 64)
        tensor = sst(data, sparsity=0.05, device='cpu')
        
        print(f'Compression: {tensor.compress_ratio():.1f}x')
        assert tensor.compress_ratio() > 1.0
        
        reconstructed = tensor.to_spatial()
        assert reconstructed.shape == data.shape
        
        print('✓ Basic functionality works')
        "
